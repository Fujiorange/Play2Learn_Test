# Render Deployment Guide for Play2Learn

This guide provides step-by-step instructions for deploying the Play2Learn application to Render.

## Prerequisites

1. **Render Account**: Sign up at [https://render.com](https://render.com)
2. **MongoDB Atlas Account**: Sign up at [https://www.mongodb.com/cloud/atlas](https://www.mongodb.com/cloud/atlas)
3. **SMTP Email Service**: Gmail, SendGrid, Mailgun, or similar

## Step 1: Setup MongoDB Atlas

1. Create a new MongoDB Atlas cluster (free tier available)
2. Create a database user with password
3. Whitelist all IPs (0.0.0.0/0) for Render access
4. Get your connection string - it should look like:
   ```
   mongodb+srv://username:password@cluster.mongodb.net/play2learn?retryWrites=true&w=majority
   ```

## Step 2: Prepare Email Service

**üìß See [EMAIL_SETUP_GUIDE.md](EMAIL_SETUP_GUIDE.md) for complete email setup instructions**

Quick reference - choose one option:
- **Gmail**: Free, 500 emails/day (requires App Password)
- **SendGrid**: Free tier 100 emails/day, better for production
- **Outlook/Hotmail**: Free, 300 emails/day
- **Mailgun**: Free tier 5,000 emails/month

The EMAIL_SETUP_GUIDE.md provides:
- Detailed setup steps for each service
- Environment variable configuration
- Testing instructions
- Troubleshooting tips

## Step 3: Deploy to Render

### Option A: Using render.yaml (Recommended)

1. **Fork or Push this repository to GitHub**

2. **Create New Web Service in Render:**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" ‚Üí "Web Service"
   - Connect your GitHub repository
   - Render will auto-detect the `render.yaml` file

3. **The render.yaml file is already configured with:**
   - Build Command: `npm run render-build`
   - Start Command: `npm start`
   - Environment: Node.js
   - Auto-deploy: Enabled

### Option B: Manual Configuration

If render.yaml isn't detected:

1. **Create New Web Service**
   - Name: `play2learn` (or your choice)
   - Environment: `Node`
   - Build Command: `npm run render-build`
   - Start Command: `npm start`
   - Plan: Free (or paid as needed)

## Step 4: Configure Environment Variables

In Render Dashboard ‚Üí Environment tab, add these variables:

### Required Variables

| Variable | Value | Description |
|----------|-------|-------------|
| `NODE_ENV` | `production` | Sets production environment |
| `MONGODB_URI` | `mongodb+srv://...` | Your MongoDB Atlas connection string |
| `JWT_SECRET` | `your-secret-key` | **IMPORTANT**: Use a strong, random string (32+ characters) |
| `FRONTEND_URL` | `https://your-app.onrender.com` | Your Render app URL |
| `PORT` | Auto-generated by Render | Leave as default |

### Email Configuration Variables

**üìß For detailed setup instructions, see [EMAIL_SETUP_GUIDE.md](EMAIL_SETUP_GUIDE.md)**

Required email variables (6 total):

| Variable | Example Value | Description |
|----------|---------------|-------------|
| `EMAIL_HOST` | `smtp.gmail.com` | SMTP server hostname |
| `EMAIL_PORT` | `587` | SMTP port (587 for TLS, 465 for SSL) |
| `EMAIL_SECURE` | `false` | Use `false` for port 587, `true` for 465 |
| `EMAIL_USER` | `your-email@gmail.com` | SMTP username/email |
| `EMAIL_PASSWORD` | `your-app-password` | SMTP password (use App Password for Gmail) |
| `EMAIL_FROM` | `"Play2Learn <noreply@play2learn.com>"` | From address for emails |

**Quick Examples:**

Gmail:
```
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-16-char-app-password
EMAIL_FROM="Play2Learn <your-email@gmail.com>"
```

SendGrid (Recommended for Production):
```
EMAIL_HOST=smtp.sendgrid.net
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=apikey
EMAIL_PASSWORD=SG.your-api-key
EMAIL_FROM="Play2Learn <verified-sender@yourdomain.com>"
```

### Optional Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `USER_DELETION_PIN` | (none) | PIN for user deletion confirmation |

## Step 5: Deploy

1. Click **"Create Web Service"** or **"Save Changes"**
2. Render will automatically:
   - Clone your repository
   - Run `npm run render-build` (installs deps + builds frontend)
   - Run `npm start` (starts backend server)
   - Assign a URL like `https://play2learn.onrender.com`

3. Monitor deployment in the **Logs** tab

## Step 6: Initialize Database (First Time Only)

After successful deployment:

1. **Open Render Shell:**
   - Go to your service in Render Dashboard
   - Click "Shell" tab (top right)

2. **Run initialization script:**
   ```bash
   cd backend
   node init-trial-license.js
   ```

3. **Verify output:**
   ```
   ‚úÖ Connected to MongoDB
   ‚úÖ Created Free Trial license successfully
   ```

## Step 7: Verify Deployment

1. **Check Health Endpoint:**
   ```
   https://your-app.onrender.com/api/health
   ```
   Should return:
   ```json
   {
     "success": true,
     "message": "Server is healthy",
     "database": {
       "status": "Connected",
       "connected": true
     }
   }
   ```

2. **Check Test Endpoint:**
   ```
   https://your-app.onrender.com/api/test
   ```

3. **Access Application:**
   - Navigate to `https://your-app.onrender.com`
   - Try registration and login

## Troubleshooting

### Issue: Build Fails with "CI=true" Warning

**Solution:** Already fixed in `package.json` with `CI=false` flag

### Issue: MongoDB Connection Failed

**Causes:**
- Wrong connection string format
- Database user password contains special characters (must be URL-encoded)
- IP whitelist not set to 0.0.0.0/0

**Solution:**
1. Verify MONGODB_URI in Render environment variables
2. URL-encode special characters in password
3. Check MongoDB Atlas network access settings

### Issue: JWT_SECRET Error

**Error:** "JWT_SECRET must be set in the production environment"

**Solution:** Add `JWT_SECRET` environment variable with a strong random string

### Issue: Email Not Sending

**Causes:**
- Wrong SMTP credentials
- Gmail blocking sign-in (need App Password)
- Wrong EMAIL_PORT or EMAIL_SECURE combination

**Solution:**
1. Verify all EMAIL_* variables are set
2. Use App Password for Gmail (not regular password)
3. Use `EMAIL_PORT=587` with `EMAIL_SECURE=false`

### Issue: CORS Errors

**Error:** "Not allowed by CORS"

**Solution:**
1. Set `FRONTEND_URL` environment variable to your Render app URL
2. Verify URL matches exactly (with https://)

### Issue: Application Not Loading (404)

**Causes:**
- Frontend build failed
- Build directory not created

**Solution:**
1. Check build logs for errors
2. Verify `npm run render-build` completed successfully
3. Check if `frontend/build` directory was created

### Issue: Port Already in Use

**Solution:** Render automatically assigns PORT - don't set it manually

## Post-Deployment Checklist

- [ ] Deployment successful (green in Render)
- [ ] Database connected (`/api/health` returns success)
- [ ] Free Trial license initialized (`node init-trial-license.js`)
- [ ] Can register new institute
- [ ] Can login to application
- [ ] Email sending works (test registration/password reset)
- [ ] All environment variables set
- [ ] Auto-deploy enabled for main branch

## Updating Your Application

Render will automatically redeploy when you push to your main branch.

To manually redeploy:
1. Go to Render Dashboard
2. Select your service
3. Click "Manual Deploy" ‚Üí "Deploy latest commit"

## Free Tier Limitations

Render's free tier:
- ‚úÖ Perfect for testing/development
- ‚ö†Ô∏è App spins down after 15 minutes of inactivity
- ‚ö†Ô∏è Cold starts take 30-60 seconds
- ‚ö†Ô∏è 750 hours/month limit

For production, consider upgrading to a paid plan.

## Security Recommendations

1. **JWT_SECRET**: Use a cryptographically random string:
   ```bash
   # Generate on your machine:
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```

2. **Regular Updates**: Keep dependencies updated
   ```bash
   npm update
   npm audit fix
   ```

3. **Environment Variables**: Never commit `.env` files to Git

4. **Database Access**: Restrict MongoDB Atlas IP whitelist if possible

## Support

For deployment issues:
- Check Render logs: Dashboard ‚Üí Your Service ‚Üí Logs
- Check this deployment guide
- Review `DEPLOYMENT_CHECKLIST.md` for application-specific steps

## Additional Resources

- [Render Documentation](https://render.com/docs)
- [MongoDB Atlas Documentation](https://docs.atlas.mongodb.com/)
- [Node.js Deployment Guide](https://render.com/docs/deploy-node-express-app)
